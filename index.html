<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แผ่นจุ่มกำลังใจ</title>
<style>
@font-face {
  font-family: 'PG Rohan DEMO';
  src: url('PG Rohan DEMO.ttf') format('truetype');
}
body { 
  font-family: 'PG Rohan DEMO', cursive; 
  text-align: center; 
  background: #ffffff; 
  color: #000000; 
  margin: 0; 
  padding: 20px;
}
h1 { font-size:2.5em; margin-bottom:10px; }
p { font-size:1.2em; margin-bottom:30px; }

/* ตะกร้า */
#basket { 
  width:180px; margin:20px auto; cursor:pointer; transition: transform 0.2s; display:block;
}
.shake { animation: shake 0.5s; }
@keyframes shake{
  0% {transform:translate(0,0) rotate(0deg);}
  25% {transform:translate(-5px,0) rotate(-5deg);}
  50% {transform:translate(5px,0) rotate(5deg);}
  75% {transform:translate(-5px,0) rotate(-5deg);}
  100% {transform:translate(0,0) rotate(0deg);}
}

/* กระดาษ */
.paper { 
  width:140px; height:90px; 
  background:#fdfdfd; border:none; border-radius:12px; 
  margin:20px auto; cursor:pointer;
  display:flex; justify-content:center; align-items:center;
  font-size:16px; color:#000000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  transition: transform 0.2s, box-shadow 0.2s;
}
.paper:hover { 
  transform: scale(1.05); box-shadow:0 6px 14px rgba(0,0,0,0.3); 
  background:#f8f8f8;
}

/* Scratch container */
#scratch-container { 
  position:relative; display:none; width:90%; max-width:400px; margin:20px auto; border-radius:12px; box-shadow:0 6px 12px rgba(0,0,0,0.15);
}
#main-img { width:100%; border-radius:12px; display:block; }
#scratchCanvas { position:absolute; top:0; left:0; border-radius:12px; }

/* ปุ่มดาวน์โหลด */
#downloadBtn { 
  display:none; margin-top:20px; padding:10px 20px; background:#000000; color:white; border:none; border-radius:12px; cursor:pointer; font-size:16px;
  transition: transform 0.2s, background 0.2s;
}
#downloadBtn:hover { background:#333333; transform: scale(1.05); }

#papers { margin-top:20px; }
button#startBtn { padding:10px 20px; margin-bottom:20px; font-size:16px; cursor:pointer; border-radius:12px; border:none; background:#000000; color:#fff; }
button#startBtn:hover { background:#333333; }
</style>
</head>
<body>
<h1>แผ่นจุ่มกำลังใจ</h1>
<p>เขย่าตะกร้าแล้วเลือกกระดาษเพื่อขูดดูรูป</p>

<button id="startBtn">แตะเพื่อเริ่ม</button>
<img id="basket" src="Untitled design (13).png" alt="basket">

<div id="papers"></div>

<div id="scratch-container">
  <img id="main-img" src="" alt="main">
  <canvas id="scratchCanvas"></canvas>
</div>

<button id="downloadBtn">ดาวน์โหลดภาพ</button>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const basket = document.getElementById("basket");
const papers = document.getElementById("papers");
const container = document.getElementById("scratch-container");
const canvas = document.getElementById("scratchCanvas");
const ctx = canvas.getContext("2d");
const mainImg = document.getElementById("main-img");
const downloadBtn = document.getElementById("downloadBtn");
const startBtn = document.getElementById("startBtn");

const papersImages = ["คำคม1.jpg","photo2.jpg","photo3.jpg"];
let currentImage = "";

// แสดงกระดาษ
function showPaper(){
  if(papers.children.length>0) return;
  basket.classList.add("shake");
  setTimeout(()=>basket.classList.remove("shake"),600);

  const paper=document.createElement("div");
  paper.className="paper";
  paper.innerText="คลิกเพื่อขูด";
  currentImage = papersImages[Math.floor(Math.random()*papersImages.length)];
  paper.onclick=startScratch;
  papers.appendChild(paper);
}

// เขย่าตะกร้า
function motionHandler(e){
  const acc = e.accelerationIncludingGravity;
  if(acc && (Math.abs(acc.x)+Math.abs(acc.y)+Math.abs(acc.z) > 30)){
    showPaper();
  }
}

// เริ่มระบบ motion (iOS ต้อง permission)
startBtn.onclick = () => {
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission().then(response=>{
      if(response==='granted') window.addEventListener('devicemotion', motionHandler);
    });
  } else {
    window.addEventListener('devicemotion', motionHandler);
  }
  startBtn.style.display="none";
};

// Mouse shake สำหรับ desktop
document.addEventListener("mousemove",e=>{
  if(Math.abs(e.movementX)+Math.abs(e.movementY)>30) showPaper();
});

// Scratch effect
function startScratch(){
  papers.innerHTML="";
  container.style.display="block";
  mainImg.src = currentImage;

  mainImg.onload = () => {
    canvas.width = mainImg.clientWidth;
    canvas.height = mainImg.clientHeight;

    ctx.fillStyle="#c0c0c0";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    setupScratchEvents();
  };
}

function setupScratchEvents(){
  let drawing=false;

  canvas.addEventListener("mousedown",()=>drawing=true);
  canvas.addEventListener("mouseup",()=>drawing=false);
  canvas.addEventListener("mouseleave",()=>drawing=false);
  canvas.addEventListener("mousemove",scratch);

  canvas.addEventListener("touchstart",()=>drawing=true);
  canvas.addEventListener("touchend",()=>drawing=false);
  canvas.addEventListener("touchmove", e=>{
    e.preventDefault();
    scratch(e);
  }, {passive:false});

  function scratch(e){
    if(!drawing) return;
    const rect=canvas.getBoundingClientRect();
    const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
    const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
    ctx.globalCompositeOperation="destination-out";
    ctx.beginPath();
    ctx.arc(x,y,20,0,Math.PI*2);
    ctx.fill();
    checkReveal();
  }

  function checkReveal(){
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    let total=imgData.data.length/4, cleared=0;
    for(let i=0;i<imgData.data.length;i+=4){
      if(imgData.data[i+3]===0) cleared++;
    }
    if(cleared/total > 0.6){
      canvas.style.display="none";
      downloadBtn.style.display="inline-block";
      confetti({particleCount:100, spread:70, origin:{y:0.6}});
    }
  }
}

// ดาวน์โหลด
downloadBtn.onclick=function(){
  const link=document.createElement("a");
  link.download=currentImage;
  link.href=mainImg.src;
  link.click();
};
</script>
</body>
</html>
